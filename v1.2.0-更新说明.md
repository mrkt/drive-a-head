# 🔧 v1.2.0 - 多人游戏修复更新

## 📅 更新时间
**2025-11-28 晚上**

## 🐛 修复的问题

### 1. 玩家刷新后出现"僵尸车辆"问题 ✅
**问题描述**：
- 玩家刷新浏览器后，旧的车辆没有被清理
- 场景中累积了很多不受控的"僵尸车辆"

**解决方案**：
- 在玩家加入游戏时（`HandleJoinResponse`），清理所有现有的远程玩家
- 这样当玩家刷新重新连接时，会自动清理掉所有旧车辆

**修改文件**：
- `Assets/Scripts/MultiplayerManager.cs:133` - 添加 `CleanupAllRemotePlayers()` 调用
- `Assets/Scripts/MultiplayerManager.cs:270-295` - 新增 `CleanupAllRemotePlayers()` 函数

---

### 2. 玩家位置不实时更新问题 ✅
**问题描述**：
- 玩家能看到彼此，但是位置不更新
- 只能看到彼此的初始位置，看不到对方移动

**根本原因**：
- 创建远程玩家时使用的名称是 `RemotePlayer_{username}`（用户名）
- 查找玩家时使用的名称是 `RemotePlayer_{playerId}`（玩家ID）
- 用户名 ≠ 玩家ID，导致无法找到远程玩家进行位置更新

**解决方案**：
- 统一使用 `playerId` 作为 GameObject 名称
- 修改 `HandlePlayerSpawned` 中的命名逻辑

**修改文件**：
- `Assets/Scripts/MultiplayerManager.cs:219` - 改为使用 `netPlayer.id` 而不是 `netPlayer.username`

---

## 🎮 保留的功能

### ✅ 移动端虚拟摇杆（v1.1.0）
- 自动检测移动设备
- 8方向控制
- 半透明设计
- 左下角位置
- 方向指示器
- 触摸反馈

### ✅ 多人在线功能
- 6种不同车辆类型
- 服务端车辆类型分配和同步
- 车辆碰撞和重生系统
- 实时位置同步
- 玩家断开连接时的清理

---

## 📦 部署步骤

### 1. 更新服务端代码
服务端代码已经更新到 `deployment/server/` 目录，无需修改。

### 2. 重新构建 WebGL
**⚠️ 重要：必须重新构建 WebGL 才能应用客户端修复**

在 Unity 编辑器中：
1. File > Build Settings
2. 选择 WebGL 平台
3. 点击 "Build"
4. 选择输出目录（建议：`/Users/admin/unity_project/car/Builds/WebGL`）
5. 等待构建完成

### 3. 复制构建文件到 deployment
```bash
# 复制 WebGL 构建文件到 deployment 目录
cp -r /Users/admin/unity_project/car/Builds/WebGL/* /Users/admin/unity_project/car/deployment/Builds/WebGL/
```

**注意**：复制时会保留现有的虚拟摇杆文件：
- `index.html`（包含虚拟摇杆集成）
- `virtual-joystick.js`
- `virtual-joystick.css`

### 4. 上传到服务器
```bash
# 方式1：上传整个 deployment 目录（推荐）
scp -r /Users/admin/unity_project/car/deployment root@你的服务器IP:/opt/car-game/

# 方式2：只上传 WebGL 构建文件
scp -r /Users/admin/unity_project/car/deployment/Builds/WebGL root@你的服务器IP:/opt/car-game/deployment/Builds/

# 方式3：只上传服务端
scp -r /Users/admin/unity_project/car/deployment/server root@你的服务器IP:/opt/car-game/deployment/
```

### 5. 重启服务器
```bash
# SSH 登录到服务器
ssh root@你的服务器IP

# 停止旧服务器
pkill -f "./server"

# 启动新服务器
cd /opt/car-game/deployment/server
nohup ./server > server.log 2>&1 &

# 验证服务器运行
ps aux | grep "./server" | grep -v grep
```

---

## ✅ 验证更新

### 测试场景1：多人游戏
1. 打开两个浏览器窗口访问游戏
2. 检查两个玩家能否看到彼此 ✅
3. 检查位置是否实时更新 ✅
4. 检查车辆类型是否正确显示 ✅

### 测试场景2：刷新测试
1. 玩家A和玩家B都在游戏中
2. 玩家A按 F5 刷新浏览器
3. 检查玩家B的视角中，玩家A的旧车辆是否消失 ✅
4. 检查玩家A重新加入后能否看到玩家B ✅
5. 检查场景中是否没有"僵尸车辆" ✅

### 测试场景3：移动端
1. 用手机浏览器访问游戏
2. 检查虚拟摇杆是否显示 ✅
3. 检查摇杆控制是否正常 ✅
4. 检查多人游戏功能是否正常 ✅

---

## 🔧 技术细节

### 清理机制
```csharp
void CleanupAllRemotePlayers()
{
    // 销毁所有远程玩家
    foreach (var kvp in remotePlayers)
    {
        if (kvp.Value != null)
        {
            Destroy(kvp.Value);
        }
    }
    remotePlayers.Clear();

    // 销毁所有用户名显示
    foreach (var kvp in usernameDisplays)
    {
        if (kvp.Value != null)
        {
            Destroy(kvp.Value);
        }
    }
    usernameDisplays.Clear();
}
```

### 命名统一
```csharp
// 修改前（错误）
remoteCar.name = $"RemotePlayer_{netPlayer.username}";  // 使用用户名

// 修改后（正确）
remoteCar.name = $"RemotePlayer_{netPlayer.id}";  // 使用玩家ID
```

---

## 📝 已知问题

### ⚠️ 无已知问题
目前所有已知问题都已修复。

---

## 🎉 更新完成！

现在游戏应该能够：
- ✅ 正常显示多人游戏
- ✅ 实时更新玩家位置
- ✅ 刷新后不会出现僵尸车辆
- ✅ 支持移动端虚拟摇杆
- ✅ 支持6种不同车辆类型

---

**版本**：v1.2.0 - 多人游戏修复
**更新时间**：2025-11-28 晚上
**修复内容**：僵尸车辆清理 + 位置更新修复
